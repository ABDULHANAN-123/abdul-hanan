<div class="custom-product-grid">
  {% for i in (1..6) %}
    {% capture product_setting_key %}product_{{ i }}{% endcapture %}
    {% assign product_handle = section.settings[product_setting_key] %}
    {% if product_handle %}
      {% assign product = all_products[product_handle] %}
      <div class="product-block" data-variant-id="{{ product.variants.first.id }}" data-handle="{{ product.handle }}">
        <img src="{{ product.featured_image | image_url: width: 480 }}" 
             alt="{{ product.title }}" 
             width="480" height="480" loading="lazy">
        <h3>{{ product.title }}</h3>
        <p>{{ product.price | money }}</p>
      </div>
    {% endif %}
  {% endfor %}
</div>

<div id="popup" style="display:none;">
  <div class="popup-content">
    <h2 class="title"></h2>
    <p class="price"></p>
    
    <div class="options-container">
      <label>Color:</label>
      <select id="variant-color">
        <option value="Black">Black</option>
        <option value="Blue">Blue</option>
        <option value="White">White</option>
      </select>

      <label>Size:</label>
      <select id="variant-size">
        <option value="Small">Small</option>
        <option value="Medium">Medium</option>
        <option value="Large">Large</option>
      </select>
    </div>

    <p class="description"></p>
    <div class="popup-btns">
      <button class="add-btn" onclick="addToCart()">Add to Cart</button>
      <button class="close-btn" onclick="document.getElementById('popup').style.display='none'">Close</button>
    </div>
  </div>
</div>

<script>
let currentVariantId = null;

document.querySelectorAll('.product-block').forEach(block => {
  block.addEventListener('click', () => {
    currentVariantId = parseInt(block.dataset.variantId);
    let handle = block.dataset.handle;
    openPopup(handle);
  });
});

function openPopup(handle) {
  fetch(`/products/${handle}.js`)
    .then(res => res.json())
    .then(product => {
      document.querySelector('#popup .title').textContent = product.title;
      document.querySelector('#popup .price').textContent = (product.price/100).toFixed(2) + ' ' + (Shopify.currency ? Shopify.currency.active : 'USD');
      document.querySelector('#popup .description').textContent = product.description.replace(/<[^>]+>/g,'').substring(0, 150) + "...";
      document.getElementById('popup').style.display = 'flex';
    });
}

function addToCart() {
  if (!currentVariantId) return;

  const selectedColor = document.getElementById('variant-color').value;
  const selectedSize = document.getElementById('variant-size').value;

  console.log("Adding Product ID:", currentVariantId);
  console.log("Options:", selectedColor, selectedSize);

  let itemsToAdd = [{ 
    id: currentVariantId, 
    quantity: 1 
  }];

  if (selectedColor === 'Black' && selectedSize === 'Medium') {
    const jacketVariantId = 44456490827855; 
    itemsToAdd.push({ 
      id: jacketVariantId, 
      quantity: 1 
    });
    alert("Special Bonus: Soft Winter Jacket added to your cart!");
  }

  fetch('/cart/add.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ items: itemsToAdd })
  })
  .then(res => res.json())
  .then(data => {
    console.log('Cart Update Success:', data);
    window.location.href = '/cart';
  })
  .catch(error => {
    console.error('Cart Error:', error);
    alert("Error adding to cart. Please try again.");
  });
}
</script>

<style>
.custom-product-grid { 
  display: grid; 
  grid-template-columns: repeat(3, 1fr); 
  gap: 20px; 
  padding: 20px;
}
.product-block { border: 1px solid #eee; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; }
.product-block img { width: 100%; height: auto; }

#popup { 
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
  background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; 
}
.popup-content { 
  background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; 
}
.options-container select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd; }
.popup-btns { display: flex; gap: 10px; margin-top: 15px; }
.add-btn { background: #000; color: #fff; border: none; padding: 12px; cursor: pointer; flex: 2; font-weight: bold; }
.close-btn { background: #f4f4f4; border: none; padding: 12px; cursor: pointer; flex: 1; }

@media (max-width: 768px) {
  .custom-product-grid { grid-template-columns: 1fr; }
}
</style>

{% schema %}
{
  "name": "Custom Product Grid",
  "settings": [
    { "type": "product", "id": "product_1", "label": "Select Product 1" },
    { "type": "product", "id": "product_2", "label": "Select Product 2" },
    { "type": "product", "id": "product_3", "label": "Select Product 3" },
    { "type": "product", "id": "product_4", "label": "Select Product 4" },
    { "type": "product", "id": "product_5", "label": "Select Product 5" },
    { "type": "product", "id": "product_6", "label": "Select Product 6" }
  ],
  "presets": [{ "name": "Custom Product Grid" }]
}
{% endschema %}